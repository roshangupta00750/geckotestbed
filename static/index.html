<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gecko Adhesion Sequence Builder</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/chart.css">
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Zoom-resistant base settings */
    html {
      /* Prevent text size adjustment on zoom */
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f0f23;
      color: #ffffff;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
      /* Ensure proper scaling */
      zoom: 1;
    }

    /* Main dashboard container with zoom protection */
    .dashboard-container {
      width: 100%;
      min-width: 320px;
      margin: 0 auto;
      /* Prevent zoom-related layout breaks */
      transform: scale(1);
      transform-origin: top left;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      grid-template-rows: minmax(min-content, 1fr) minmax(min-content, 1fr) minmax(min-content, auto);
      gap: clamp(10px, 2vw, 20px);
      padding: clamp(10px, 2vw, 20px);
      min-height: 100vh;
      width: 100%;
      /* Prevent grid blowout */
      max-width: 100vw;
      overflow: hidden;
    }

    /* Grid positioning */
    .sequence-card {
      grid-row: 1;
      grid-column: 1;
    }

    .chart-card {
      grid-row: 2;
      grid-column: 1;
    }

    .manual-control-card {
      grid-row: 2;
      grid-column: 2;
    }

    .force-monitor {
      grid-row: 1;
      grid-column: 2;
    }

    .calibration-card {
      grid-row: 2;
      grid-column: 3;
    }

    .steps-card {
      grid-row: 1;
      grid-column: 3;
    }

    .threejs-card {
      grid-row: 1 / 3;
      grid-column: 4;
    }

    .log-card {
      grid-row: 3;
      grid-column: 1 / 5;
      max-height: 25vh;
    }

    /* Card styles with flexible sizing */
    .card {
      background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
      border-radius: clamp(12px, 2vw, 20px);
      padding: clamp(12px, 2vw, 24px);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
      transform: perspective(1000px) rotateX(0deg);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      /* Flexible height with constraints */
      min-height: 200px;
      max-height: calc(50vh - 20px);
      height: auto;
      /* Prevent content overflow */
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: perspective(1000px) rotateX(2deg) scale(1.02);
      box-shadow: 
        0 12px 48px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: clamp(8px, 1vw, 12px);
      margin-bottom: clamp(12px, 2vw, 24px);
      font-size: clamp(1rem, 2vw, 1.4rem);
      font-weight: 600;
      background: linear-gradient(45deg, #4f46e5, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      flex-shrink: 0;
    }

    .card-header i {
      background: linear-gradient(45deg, #4f46e5, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: inherit;
    }

    /* Card content wrapper for proper scrolling */
    .card-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
    }

    /* Sequence Builder Card */
    .sequence-list {
      max-height: 250px;
      overflow-y: auto;
      margin-bottom: 8px;
    }

    .sequence-card .button-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: clamp(2px, 0.5vw, 3px);
      margin-top: 8px;
    }

    /* Buttons with zoom-friendly sizing */
    .modern-btn {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      border: none;
      border-radius: clamp(6px, 1vw, 8px);
      padding: clamp(6px, 1vw, 8px) clamp(8px, 1.5vw, 12px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
      margin: 2px;
      font-size: clamp(0.7rem, 1.2vw, 0.9rem);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      /* Minimum touch target size */
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .modern-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .sequence-card .modern-btn {
      transform: perspective(1000px) rotateX(0deg) translateZ(0px);
      box-shadow: 
         0 6px 12px rgba(79, 70, 229, 0.3),
         0 2px 4px rgba(0, 0, 0, 0.2),
         inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
    }
     
    .sequence-card .modern-btn:hover {
      transform: perspective(1000px) rotateX(-8deg) translateZ(10px) translateY(-3px);
      box-shadow: 
         0 12px 24px rgba(79, 70, 229, 0.4),
         0 6px 12px rgba(0, 0, 0, 0.3),
         inset 0 2px 0 rgba(255, 255, 255, 0.15);
    }
     
    .sequence-card .modern-btn:active {
      transform: perspective(1000px) rotateX(-4deg) translateZ(5px) translateY(-1px);
      box-shadow: 
         0 6px 12px rgba(79, 70, 229, 0.5),
         0 3px 6px rgba(0, 0, 0, 0.4),
         inset 0 3px 6px rgba(0, 0, 0, 0.2);
    }

    .sequence-card .modern-btn.danger:hover {
      box-shadow: 
         0 12px 24px rgba(220, 38, 38, 0.4),
         0 6px 12px rgba(0, 0, 0, 0.3),
         inset 0 2px 0 rgba(255, 255, 255, 0.15);
    }
    .modern-btn:disabled {
      background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .modern-btn.danger {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
    }

    /* Modern Force Monitor - Updated Design */
    .force-monitor {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .force-gauge-container {
      position: relative;
      width: clamp(140px, 18vw, 200px);
      height: clamp(140px, 18vw, 200px);
      margin: 20px auto;
    }

    .force-gauge {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: conic-gradient(
        from 0deg,
        #3b82f6 0deg,
        #8b5cf6 var(--progress, 90deg),
        rgba(255, 255, 255, 0.1) var(--progress, 90deg),
        rgba(255, 255, 255, 0.1) 360deg
      );
      box-shadow: 
        0 0 30px rgba(139, 92, 246, 0.3),
        inset 0 0 40px rgba(0, 0, 0, 0.6);
    }

    .force-gauge::before {
      content: '';
      position: absolute;
      width: 80%;
      height: 80%;
      background: radial-gradient(circle, #2a2a3e 0%, #1a1a2e 100%);
      border-radius: 50%;
      z-index: 1;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
    }

    .force-gauge-center {
      position: relative;
      z-index: 2;
      text-align: center;
    }

    .force-main-display {
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 900;
      color: #ffffff;
      margin: 0;
      line-height: 1;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
    }

    .force-unit-text {
      font-size: clamp(0.9rem, 1.5vw, 1.1rem);
      color: rgba(255, 255, 255, 0.8);
      margin-top: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .force-details {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: clamp(4px, 1vw, 8px);
      margin-top: 16px;
      width: 100%;
    }

    .force-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: clamp(8px, 1.2vw, 12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
    }

    .force-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    .force-item .label {
      font-size: clamp(0.7rem, 1vw, 0.9rem);
      opacity: 0.7;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .force-item .value {
      font-size: clamp(0.9rem, 1.3vw, 1.1rem);
      font-weight: 700;
      font-family: 'Courier New', monospace;
      color: #06b6d4;
    }

    /* Manual Control */
    .manual-control-card {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      position: relative;
      overflow: visible;
    }

    .axis-controls {
      display: flex;
      flex-direction: column;
      gap: clamp(8px, 1.5vw, 12px);
    }

    .axis-group {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: clamp(8px, 1.5vw, 12px);
      transition: all 0.2s ease;
    }

    .axis-label {
      font-size: clamp(0.9rem, 1.5vw, 1rem);
      font-weight: 700;
      margin-bottom: 8px;
      text-align: center;
      background: linear-gradient(45deg, #06b6d4, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .axis-buttons {
      display: flex;
      justify-content: center;
      gap: clamp(8px, 1.5vw, 12px);
    }

    .axis-btn {
      width: clamp(35px, 5vw, 45px);
      height: clamp(35px, 5vw, 45px);
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
      color: #ffffff;
      font-size: clamp(1rem, 1.5vw, 1.2rem);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 
        0 2px 6px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      /* Minimum touch target */
      min-width: 35px;
      min-height: 35px;
    }

    .axis-btn:hover {
      transform: translateY(-2px) scale(1.05);
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      box-shadow: 
        0 4px 12px rgba(79, 70, 229, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    /* Steps Display */
    .steps-display {
      text-align: center;
      font-family: 'Courier New', monospace;
      font-size: clamp(1.4rem, 3vw, 2rem);
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 100px;
    }

    .steps-display .step-value {
      color: #06b6d4;
      font-weight: 700;
      font-size: clamp(1.6rem, 3.5vw, 2.2rem);
    }

    /* Sequence Steps */
    .sequence-step {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: clamp(6px, 1vw, 8px);
      margin-bottom: 6px;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
      font-size: clamp(0.75rem, 1.2vw, 0.85rem);
    }

    .sequence-step:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Calibration Card */
    .calibration-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 0;
      gap: clamp(8px, 1vw, 12px);
    }

    .calibration-content {
      margin-top: 12px;
      opacity: 1;
      display: block !important;
    }

    .calibration-card.expanded .calibration-content {
      display: block !important;
      opacity: 1;
      max-height: 300px;
    }

    .calibration-form {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: clamp(4px, 1vw, 8px);
      margin-bottom: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group label {
      font-size: clamp(0.7rem, 1vw, 0.8rem);
      opacity: 0.8;
    }

    .form-group input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: clamp(4px, 0.8vw, 6px) clamp(6px, 1vw, 8px);
      color: #ffffff;
      font-size: clamp(0.7rem, 1vw, 0.8rem);
      min-height: 28px;
    }

    /* File Operations */
    .file-operations {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: clamp(4px, 1vw, 8px);
      margin-top: 12px;
    }

    .file-card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      padding: clamp(6px, 1vw, 8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .file-card h3 {
      font-size: clamp(0.7rem, 1vw, 0.8rem);
      margin-bottom: 8px;
      opacity: 0.9;
    }

    /* Log Entries */
    .log-entries {
      list-style: none;
      padding: 0;
      font-family: 'Courier New', monospace;
      font-size: clamp(0.65rem, 1vw, 0.75rem);
      max-height: 200px;
      overflow-y: auto;
    }

    .log-entries li {
      padding: 2px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      opacity: 0.8;
    }

    .log-entries li:first-child {
      opacity: 1;
      color: #06b6d4;
    }

    /* Collapsible */
    .calibration-card {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
    }

    /* Responsive Design - Optimized for all zoom levels */
    @media (max-width: 1400px) {
      .dashboard-grid {
        gap: clamp(8px, 1.5vw, 15px);
        padding: clamp(8px, 1.5vw, 15px);
      }
      
      .card {
        max-height: calc(50vh - 15px);
      }
    }

    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-template-rows: repeat(4, minmax(min-content, auto)) auto;
      }

      .sequence-card {
        grid-row: 1;
        grid-column: 1;
      }

      .chart-card {
        grid-row: 2;
        grid-column: 1;
      }

      .manual-control-card {
        grid-row: 1;
        grid-column: 2;
      }

      .force-monitor {
        grid-row: 2;
        grid-column: 2;
      }

      .calibration-card {
        grid-row: 3;
        grid-column: 1;
      }

      .steps-card {
        grid-row: 3;
        grid-column: 2;
      }

      .threejs-card {
        grid-row: 4;
        grid-column: 1 / 3;
        min-height: 400px;
      }

      .log-card {
        grid-row: 5;
        grid-column: 1 / 3;
      }
 
      .card {
        max-height: none;
        height: auto;
        min-height: 250px;
      }
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(8, auto);
      }

      .sequence-card,
      .chart-card,
      .manual-control-card,
      .force-monitor,
      .calibration-card, 
      .steps-card,
      .threejs-card,
      .log-card {
        grid-row: auto;
        grid-column: 1;
      }
      
      .card {
        max-height: none;
        height: auto;
        min-height: 200px;
      }

      .sequence-card .button-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Manual Control Animation */
    .manual-control-card::before {
      content: '';
      position: absolute;
      top: -1px;
      left: -1px;
      right: -1px;
      bottom: -1px;
      background: linear-gradient(45deg, #4f46e5, #7c3aed, #06b6d4);
      border-radius: 17px;
      z-index: -1;
      animation: rotate 3s linear infinite;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Prevent layout shift on zoom */
    @media screen and (-webkit-min-device-pixel-ratio: 0) {
      .dashboard-grid {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
      }
    }

    /* High DPI screen support */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .card {
        image-rendering: -webkit-optimize-contrast;
      }
    }

    /* Three.js Visualization Styles */
    .threejs-card {
      position: relative;
      overflow: hidden;
    }

    #threejs-container {
      width: 100%;
      height: 100%;
      min-height: 400px;
      border-radius: 12px;
      overflow: hidden;
      background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f23 100%);
    }

    #threejs-container canvas {
      border-radius: 12px;
      display: block;
    }

    .threejs-controls {
      position: absolute;
      top: 60px;
      right: 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 10;
    }

    .threejs-btn {
      background: rgba(79, 70, 229, 0.8);
      border: none;
      border-radius: 6px;
      color: white;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .threejs-btn:hover {
      background: rgba(79, 70, 229, 1);
      transform: translateY(-1px);
    }

    .threejs-info {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-grid">
      
      <!-- Sequence Builder Card -->
      <div class="card sequence-card">
        <div class="card-header">
          <i class="fas fa-vial"></i>
          Sequence Builder
        </div>

        <div class="card-content">
          <div id="sequence-list" class="sequence-list">
            <!-- Dynamic sequence steps will be added here -->
          </div>

          <div class="button-grid">
            <button class="modern-btn" id="add-action-z" disabled>
              <i class="fas fa-plus-circle"></i> Add Z-Axis Step
            </button>
            <button class="modern-btn" id="add-action-x" disabled>
              <i class="fas fa-plus-circle"></i> Add X-Axis Step
            </button>
            <button class="modern-btn" id="add-action-y" disabled>
              <i class="fas fa-plus-circle"></i> Add Y-Axis Step
            </button>

            <button class="modern-btn" id="run-sequence" disabled>
              <i class="fas fa-play"></i> Run Sequence
            </button>
            <button class="modern-btn" id="link-repeat-exp">
              <i class="fas fa-repeat"></i> Repeat?
            </button>
            <div id="repeat-experiments" style="display: none;">
              <input id="repeat-experiments-input" type="number" style="width: 60px; margin-right: 8px;"><span>times</span>
            </div>

            <button class="modern-btn danger" id="stop-sequence">
              <i class="fas fa-stop"></i> Stop Sequence
            </button>
            <button class="modern-btn danger" id="emergency-stop">Emergency Stop</button>
            <button class="modern-btn" id="motor-check">Motor Check</button>
            <button class="modern-btn" id="export-data">Export Data</button>
            <button class="modern-btn" id="zero-force-sensor">Zero Force Sensor</button>
          </div>
        </div>
      </div>

      <!-- Manual Testbed Alignment Card -->
      <div class="card manual-control-card">
        <div class="card-header">
          <i class="fas fa-gamepad"></i>
          Manual Testbed Alignment
        </div>

        <div class="card-content">
          <div class="axis-controls">
            <div class="axis-group">
              <div class="axis-label">X Axis</div>
              <div class="axis-buttons">
                <button class="axis-btn" data-axis="X" data-dir="0">←</button>
                <button class="axis-btn" data-axis="X" data-dir="1">→</button>
              </div>
            </div>

            <div class="axis-group">
              <div class="axis-label">Y Axis</div>
              <div class="axis-buttons">
                <button class="axis-btn" data-axis="Y" data-dir="0">←</button>
                <button class="axis-btn" data-axis="Y" data-dir="1">→</button>
              </div>
            </div>

            <div class="axis-group">
              <div class="axis-label">Z Axis</div>
              <div class="axis-buttons">
                <button class="axis-btn" data-axis="Z" data-dir="0">↓</button>
                <button class="axis-btn" data-axis="Z" data-dir="1">↑</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Steps Display Card -->
      <div class="card steps-card">
        <div class="card-header">
          <i class="fas fa-tachometer-alt"></i>
          Steps Monitor
        </div>
        <div class="card-content">
          <div class="steps-display">
            <div>
              X <span id="x-steps" class="step-value">0</span> | 
              Y <span id="y-steps" class="step-value">0</span> | 
              Z <span id="z-steps" class="step-value">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensor Calibration Card (Collapsible) -->
      <div class="card calibration-card" id="calibration-card">
        <div class="card-header calibration-header">
          <i class="fas fa-cog"></i>
          Sensor Calibration
        </div>
        
        <div class="calibration-content">
          <form id="calibration-form" class="calibration-form">
            <div class="form-group">
              <label>Fx Factor</label>
              <input type="number" step="0.01" id="fx-factor" value="20.0" required>
            </div>
            <div class="form-group">
              <label>Fy Factor</label>
              <input type="number" step="0.01" id="fy-factor" value="20.0" required>
            </div>
            <div class="form-group">
              <label>Fz Factor</label>
              <input type="number" step="0.01" id="fz-factor" value="20.0" required>
            </div>
          </form>
          <button type="submit" class="modern-btn" form="calibration-form">
            <i class="fas fa-check"></i> Apply Calibration
          </button>
          
          <div class="file-operations">
            <div class="file-card">
              <h3>Upload JSON</h3>
              <input type="file" id="fileInput" accept=".json" style="display: none;" />
              <button id="uploadBtn" class="modern-btn">Choose File</button>
            </div>
            <div class="file-card">
              <h3>Download JSON</h3>
              <button id="downloadBtn" class="modern-btn">Download</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Force Monitor Card - Updated Design -->
      <div class="card force-monitor">
        <div class="card-header">
          <i class="fas fa-bolt"></i>
          Fz Load Monitor
        </div>

        <div class="card-content">
          <div class="force-gauge-container">
            <div class="force-gauge" id="force-gauge">
              <div class="force-gauge-center">
                <div id="fzTacho" class="force-main-display">0.00</div>
                <div class="force-unit-text">N</div>
              </div>
            </div>
          </div>

          <div class="force-details">
            <div class="force-item">
              <div class="label">Fx</div>
              <div id="fx" class="value">0.00 N</div>
            </div>
            <div class="force-item">
              <div class="label">Fy</div>
              <div id="fy" class="value">0.00 N</div>
            </div>
            <div class="force-item">
              <div class="label">Fz</div>
              <div id="fz" class="value">0.00 N</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Live Charts Card -->
      <div class="card chart-card">
        <div class="card-header">
          <i class="fas fa-chart-line"></i>
          Live Charts
        </div>
        <div class="card-content" id="chart-panel">
          <div id="chart-stack" style="display: flex; flex-direction: column-reverse; gap: 0.5em;"></div>
        </div>
      </div>

      <!-- Three.js 3D Visualization Card -->
      <div class="card threejs-card">
        <div class="card-header">
          <i class="fas fa-cube"></i>
          3D Testbed Visualization
        </div>
        <div class="card-content">
          <div id="threejs-container"></div>
          <div class="threejs-controls">
            <button class="threejs-btn" onclick="window.visualizerIntegration?.resetView()">
              <i class="fas fa-home"></i> Reset View
            </button>
            <button class="threejs-btn" onclick="toggleThreeJSInfo()">
              <i class="fas fa-info"></i> Info
            </button>
          </div>
          <div class="threejs-info" id="threejs-info" style="display: none;">
            Position: X=<span id="pos-x">0</span> Y=<span id="pos-y">0</span> Z=<span id="pos-z">0</span><br>
            Force: Fz=<span id="force-z">0.00</span>N
          </div>
        </div>
      </div>

      <!-- Live Log Card -->
      <div class="card log-card">
        <div class="card-header">
          <i class="fas fa-terminal"></i>
          Live Log
        </div>
        <div class="card-content">
          <ul id="log-entries" class="log-entries"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Load ES6 modules properly -->
  <script type="module">
    // Import and initialize chart panel first
    import { initChartPanel } from '/static/chartPanel.js';
    
    // Import socket for connection
    import '/static/socket.js';
    
    // Import main module which contains button event listeners
    import '/static/main.js';
    
    // Initialize chart panel
    initChartPanel();
    
    console.log('All modules loaded successfully');
  </script>

  <script>

    // Update modern force gauge
    function updateForceGauge(fzValue) {
      const gauge = document.getElementById('force-gauge');
      
      // Calculate progress (0-270 degrees) based on force value
      const maxForce = 20;
      const normalizedValue = Math.abs(fzValue) / maxForce;
      const progress = Math.min(normalizedValue * 270, 270); // Max 270 degrees
      
      // Update CSS custom property for progress
      gauge.style.setProperty('--progress', `${progress}deg`);
    }

    // Override force update to include gauge
    const originalForceUpdate = window.updateForceDisplay || function() {};
    window.updateForceDisplay = function(data) {
      originalForceUpdate(data);
      const fz = data.Fz ?? 0;
      updateForceGauge(fz);
    };

    // Keep your existing axis control script exactly as is
    document.querySelectorAll('button[data-axis]').forEach(btn => {
      const axis = btn.dataset.axis;
      const dir  = btn.dataset.dir;
      const start = () => fetch(`/start?axis=${axis}&dir=${dir}`);
      const stop  = () => fetch(`/stop?axis=${axis}`);
      btn.addEventListener('mousedown', start);
      btn.addEventListener('touchstart', start);
      btn.addEventListener('mouseup',   stop);
      btn.addEventListener('mouseleave',stop);
      btn.addEventListener('touchend',  stop);
    });

    // Three.js helper functions
    function toggleThreeJSInfo() {
      const info = document.getElementById('threejs-info');
      info.style.display = info.style.display === 'none' ? 'block' : 'none';
    }

    // Update Three.js info display
    function updateThreeJSInfo() {
      const xSteps = document.getElementById('x-steps')?.textContent || '0';
      const ySteps = document.getElementById('y-steps')?.textContent || '0';
      const zSteps = document.getElementById('z-steps')?.textContent || '0';
      const fzValue = document.getElementById('fzTacho')?.textContent || '0.00';

      document.getElementById('pos-x').textContent = xSteps;
      document.getElementById('pos-y').textContent = ySteps;
      document.getElementById('pos-z').textContent = zSteps;
      document.getElementById('force-z').textContent = fzValue;
    }

    // Update info display periodically
    setInterval(updateThreeJSInfo, 500);
  </script>
</body>
</html>